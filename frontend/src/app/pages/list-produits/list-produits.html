<app-navbar></app-navbar>

<div class="page-wrapper">
  <div class="produits-container">

    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary"></div>
    </div>

    <!-- Erreur -->
    <div *ngIf="error" class="alert alert-danger">
      {{ error }}
    </div>

    <!-- Groupes par boutique -->
    <div *ngFor="let groupe of produitsGroupes" class="mb-5">

      <h3 class="mb-4 border-bottom pb-2">
        {{ groupe.boutique.nom }}
      </h3>

      <div class="row g-4">
        <div class="col-xl-3 col-lg-4 col-md-6" *ngFor="let produit of groupe.produits">
          <div class="card h-100 shadow-sm position-relative product-card"
               (click)="openDetails(produit)">

            <!-- Cœur favoris (uniquement pour client) -->
            <button 
              *ngIf="isClient"
              class="btn btn-sm position-absolute top-0 end-0 m-2 p-0 bg-transparent border-0 favorite-btn"
              (click)="toggleFavorite(produit); $event.stopPropagation()"
              title="{{ produit.isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris' }}"
            >
              <i class="bi"
                [ngClass]="produit.isFavorite ? 'bi-heart-fill text-danger' : 'bi-heart text-muted'">
              </i>
            </button>

            <img
              [src]="getImageUrl(produit.image)"
              class="card-img-top"
              alt="{{ produit.nom }}"
            />

            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ produit.nom }}</h5>

              <p class="card-text text-muted mb-1">
                Stock : {{ produit.qt_actuel }}
              </p>

              <div class="mt-auto d-flex justify-content-between align-items-center">
                <p class="fw-bold text-primary mb-0">
                  {{ produit.prix_actuel | number }} Ar
                </p>
                <button 
                  class="btn btn-outline-primary btn-sm"
                  (click)="openDetails(produit); $event.stopPropagation()"
                >
                  Voir détails
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- ===================== MODAL DÉTAILS PRODUIT ==================== -->
<div class="modal fade" id="produitDetailModal" tabindex="-1" aria-labelledby="produitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    
    <div class="modal-content border-0 shadow rounded-4 overflow-hidden" *ngIf="selectedProduit; else noProduit">

      <!-- Header -->
      <div class="modal-header bg-light border-0 pb-2 pt-4 px-4 px-md-5">
        <h5 class="modal-title fw-bold fs-4" id="produitModalLabel">
          {{ selectedProduit.nom }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body px-4 px-md-5 pb-4">
        <div class="row g-4 align-items-start">

          <!-- Photo (à gauche, taille contrôlée) -->
          <div class="col-md-5 text-center">
            <img 
              [src]="getImageUrl(selectedProduit.image)" 
              class="img-fluid rounded-3 shadow-sm" 
              alt="{{ selectedProduit.nom }}"
              style="max-height: 320px; object-fit: contain; width: auto;"
            >
          </div>

          <!-- Infos texte (à droite) -->
          <div class="col-md-7">
            <!-- Prix -->
            <h4 class="fw-bold text-primary mb-3">
              {{ selectedProduit.prix_actuel | number:'1.0-0' }} Ar
            </h4>

            <!-- Stock -->
            <p class="mb-3">
              <strong>Stock :</strong> 
              <span [ngClass]="{
                'text-success fw-bold': selectedProduit.qt_actuel > 0,
                'text-danger fw-bold': selectedProduit.qt_actuel <= 0
              }">
                {{ selectedProduit.qt_actuel }}
              </span>
              <span *ngIf="selectedProduit.qt_actuel <= 0" class="text-danger ms-2">(rupture)</span>
            </p>

            <!-- Boutique -->
            <p class="mb-4">
              <strong>Boutique :</strong> 
              {{ selectedProduit.boutique?.nom || 'Non renseignée' }}
            </p>

            <!-- Description complète -->
            <div class="mb-3">
              <strong>Description :</strong>
              <p class="mt-2 text-muted" 
                style="white-space: pre-line; line-height: 1.6;">
                {{ selectedProduit.description || 'Aucune description disponible.' }}
              </p>
            </div>
          </div>

        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer border-0 pt-0 px-4 px-md-5 pb-4">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
          Fermer
        </button>
      </div>

    </div>

    <!-- Cas où selectedProduit est null (rare normalement) -->
    <ng-template #noProduit>
      <div class="modal-content text-center p-5">
        <p class="text-muted fs-5">Aucun produit sélectionné</p>
      </div>
    </ng-template>

  </div>
</div>

<app-footer></app-footer>