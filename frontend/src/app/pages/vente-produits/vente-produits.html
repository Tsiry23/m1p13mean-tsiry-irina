<app-sidebar></app-sidebar>

<div class="page-wrapper ms-sidebar" id="container">
  <div class="container-fluid py-4">

    <h2 class="mb-4">Vente Produits</h2>

    <!-- Loading / Erreurs globales -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Chargement des produits...</p>
    </div>

    <div *ngIf="error && !loading" class="alert alert-danger">
      {{ error }}
    </div>

    <!-- Liste des produits -->
    <div *ngIf="!loading && !error" class="row g-4 mb-5">
      <div class="col-xl-3 col-lg-4 col-md-6" *ngFor="let produit of produits">
        <div class="card h-100 shadow-sm position-relative">

          <img
            [src]="getImageUrl(produit.image)"
            class="card-img-top"
            alt="{{ produit.nom }}"
            style="height: 180px; object-fit: cover;"
          />

          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ produit.nom }}</h5>

            <p class="text-muted small mb-1">
              Stock : {{ produit.qt_actuel }}
            </p>

            <p class="fw-bold text-primary mb-3">
              {{ produit.prix_actuel | number:'1.0-0' }} Ar
            </p>

            <div class="mt-auto">
              <ng-container *ngIf="!panier[produit._id]; else controls">
                <button
                  class="btn btn-outline-success w-100"
                  (click)="ajouterAuPanier(produit)"
                  [disabled]="produit.qt_actuel < 1 || transactionLoading"
                >
                  <i class="bi bi-cart-plus"></i> Ajouter
                </button>
              </ng-container>

              <ng-template #controls>
                <div class="d-flex align-items-center justify-content-between">
                  <button
                    class="btn btn-sm btn-outline-danger"
                    (click)="retirerDuPanier(produit._id)"
                    [disabled]="transactionLoading"
                  >
                    ×
                  </button>

                  <input
                    type="number"
                    class="form-control form-control-sm text-center mx-2"
                    min="1"
                    [max]="produit.qt_actuel"
                    [(ngModel)]="panier[produit._id].quantite"
                    (ngModelChange)="changerQuantite(produit._id, $event)"
                    style="width: 70px;"
                    [disabled]="transactionLoading"
                  />

                  <span class="small text-muted"> / {{ produit.qt_actuel }}</span>
                </div>
              </ng-template>
            </div>
          </div>

          <span
            *ngIf="produit.qt_actuel <= 5 && produit.qt_actuel > 0"
            class="position-absolute top-0 end-0 badge bg-warning text-dark m-2"
          >
            Stock faible
          </span>
          <span
            *ngIf="produit.qt_actuel === 0"
            class="position-absolute top-0 end-0 badge bg-danger m-2"
          >
            Rupture
          </span>

        </div>
      </div>
    </div>

    <!-- Panier récap + actions -->
    <div *ngIf="!panierEstVide()" class="card bg-light mt-5 sticky-bottom shadow-lg" style="bottom: 20px; z-index: 1000;">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div>
            <h5 class="mb-1">Panier : {{ getPanierArray().length }} article(s)</h5>
            <div class="fs-4 fw-bold text-primary">
              {{ getTotalPanier() | number:'1.0-0' }} Ar
            </div>
          </div>

          <div class="d-flex flex-column flex-sm-row gap-3 align-items-center">

            <!-- Sélection moyen de paiement -->
            <div class="d-flex align-items-center gap-2">
              <label class="form-label small fw-bold mb-0">Paiement :</label>
              <select
                class="form-select form-select-sm"
                [(ngModel)]="selectedTypePaiement"
                [disabled]="paiementLoading || typesPaiement.length === 0 || transactionLoading"
              >
                <option value="" disabled>Choisir...</option>
                <option *ngFor="let t of typesPaiement" [value]="t._id">
                  {{ t.nom }}
                </option>
              </select>
            </div>

            <button
              class="btn btn-success btn-lg"
              (click)="validerVente()"
              [disabled]="!peutFaireVente() || !selectedTypePaiement || transactionLoading || paiementLoading"
            >
              <span *ngIf="transactionLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
              Valider la vente
            </button>

          </div>
        </div>

        <div *ngIf="errorMessage" class="mt-3 alert alert-danger small">
          {{ errorMessage }}
        </div>

        <div *ngIf="successMessage" class="mt-3 alert alert-success small">
          {{ successMessage }}
        </div>

        <div *ngIf="!peutFaireVente() && !errorMessage" class="mt-2 text-danger small">
          Vente impossible : stock insuffisant sur un ou plusieurs articles.
        </div>

      </div>
    </div>

  </div>
</div>