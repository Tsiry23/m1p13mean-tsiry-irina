<app-sidebar></app-sidebar>

<div class="page-wrapper ms-sidebar">
  <div class="container-fluid py-4">

    <h2 class="mb-4">Vente & Commande – Produits disponibles</h2>

    <!-- Loading / Erreur -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary"></div>
    </div>

    <div *ngIf="error" class="alert alert-danger">
      {{ error }}
    </div>

    <!-- Liste produits -->
    <div *ngIf="!loading && !error" class="row g-4 mb-5">
      <div class="col-xl-3 col-lg-4 col-md-6" *ngFor="let produit of produits">
        <div class="card h-100 shadow-sm position-relative">

          <img
            [src]="getImageUrl(produit.image)"
            class="card-img-top"
            alt="{{ produit.nom }}"
          />

          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ produit.nom }}</h5>

            <p class="text-muted small mb-1">
              Stock : {{ produit.qt_actuel }}
            </p>

            <p class="fw-bold text-primary mb-3">
              {{ produit.prix_actuel | number:'1.0-0' }} Ar
            </p>

            <!-- Zone panier / quantité -->
            <div class="mt-auto">
              <ng-container *ngIf="!panier[produit._id]; else controls">
                <button
                  class="btn btn-outline-success w-100"
                  (click)="ajouterAuPanier(produit)"
                  [disabled]="produit.qt_actuel < 1"
                >
                  <i class="bi bi-cart-plus"></i> Ajouter au panier
                </button>
              </ng-container>

              <ng-template #controls>
                <div class="d-flex align-items-center justify-content-between">
                  <button
                    class="btn btn-sm btn-outline-danger"
                    (click)="retirerDuPanier(produit._id)"
                  >
                    ×
                  </button>

                  <input
                    type="number"
                    class="form-control form-control-sm text-center mx-2"
                    min="1"
                    [max]="produit.qt_actuel"
                    [(ngModel)]="panier[produit._id].quantite"
                    (ngModelChange)="changerQuantite(produit._id, $event)"
                    style="width: 70px;"
                  />

                  <span class="small text-muted">/{{ produit.qt_actuel }}</span>
                </div>
              </ng-template>
            </div>
          </div>

          <!-- Badge stock faible -->
          <span
            *ngIf="produit.qt_actuel <= 5 && produit.qt_actuel > 0"
            class="position-absolute top-0 end-0 badge bg-warning text-dark m-2"
          >
            Stock faible
          </span>
          <span
            *ngIf="produit.qt_actuel === 0"
            class="position-absolute top-0 end-0 badge bg-danger m-2"
          >
            Rupture
          </span>

        </div>
      </div>
    </div>

    <!-- Panier récap + boutons validation -->
    <div *ngIf="!panierEstVide()" class="card bg-light mt-5 sticky-bottom shadow-lg" style="bottom: 20px; z-index: 1000;">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div>
            <h5 class="mb-1">Panier : {{ getPanierArray().length }} article(s)</h5>
            <div class="fs-4 fw-bold text-primary">
              {{ getTotalPanier() | number:'1.0-0' }} Ar
            </div>
          </div>

          <div class="d-flex gap-3">
            <button
              class="btn btn-success btn-lg"
              (click)="validerVente()"
              [disabled]="!peutFaireVente()"
              title="Vente = stock doit être suffisant"
            >
              Valider la vente
            </button>

            <button
              class="btn btn-outline-primary btn-lg"
              (click)="validerCommande()"
            >
              Valider la commande
            </button>
          </div>
        </div>

        <div *ngIf="!peutFaireVente()" class="mt-2 text-danger small">
          Vente bloquée : au moins un produit n'a pas assez de stock.
        </div>
      </div>
    </div>

  </div>
</div>