<div class="layout" id="container">
  <app-sidebar></app-sidebar>

  <main class="content align-items-start text-start">
    <h1 class="mb-4">Tableau de bord Boutique</h1>

    <!-- Filtres dates -->
    <div class="card mb-4 w-100">
      <div class="card-body d-flex gap-3 align-items-end flex-wrap">
        <div>
          <label class="form-label mb-1">Date d√©but</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="startDate" />
        </div>
        <div>
          <label class="form-label mb-1">Date fin</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="endDate" />
        </div>
        <button class="btn btn-primary btn-sm" (click)="loadDashboard()">Filtrer</button>
      </div>
    </div>

    <div *ngIf="loading" class="text-muted mb-3">Chargement des donn√©es...</div>

    <ng-container *ngIf="data && !loading">

      <!-- KPIs -->
      <div class="row g-3 w-100 mb-4">
        <div class="col-md-3">
          <div class="card metric-card bg-primary text-white h-100">
            <div class="card-body">
              <h6>CA P√©riode</h6>
              <h3>{{ data.ca_periode | number:'1.0-0' }} Ar</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card metric-card bg-success text-white h-100">
            <div class="card-body">
              <h6>Panier Moyen</h6>
              <h3>{{ data.panier_moyen_periode | number:'1.0-0' }} Ar</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card metric-card bg-info text-white h-100">
            <div class="card-body">
              <h6>Nombre de Ventes</h6>
              <h3>{{ data.nombre_ventes_periode }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card metric-card bg-warning text-dark h-100">
            <div class="card-body">
              <h6>Clients Uniques</h6>
              <h3>{{ data.clients_uniques_periode }}</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Graphiques : √âvolution ventes + CA par paiement -->
      <div class="row g-3 w-100 mb-4">

        <!-- √âvolution des ventes -->
        <div class="col-lg-8">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">√âvolution des ventes</h5>
              <div class="btn-group btn-group-sm">
                <button class="btn"
                  [class.btn-primary]="activeEvolution === 'semaine'"
                  [class.btn-outline-primary]="activeEvolution !== 'semaine'"
                  (click)="setEvolutionTab('semaine')">Semaine</button>
                <button class="btn"
                  [class.btn-primary]="activeEvolution === 'mois'"
                  [class.btn-outline-primary]="activeEvolution !== 'mois'"
                  (click)="setEvolutionTab('mois')">Mois</button>
                <button class="btn"
                  [class.btn-primary]="activeEvolution === 'annee'"
                  [class.btn-outline-primary]="activeEvolution !== 'annee'"
                  (click)="setEvolutionTab('annee')">Ann√©e</button>
              </div>
            </div>
            <div class="card-body">
              <canvas id="evolutionChart" height="120"></canvas>
            </div>
          </div>
        </div>

        <!-- CA par type de paiement -->
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">CA par type de paiement</h5>
            </div>
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
              <canvas id="paiementChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Produits plus vendus + moins performants -->
      <div class="row g-3 w-100 mb-4">

        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header"><h5 class="mb-0">üèÜ Produits les plus vendus</h5></div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Produit</th>
                    <th class="text-end">Qt√© vendue</th>
                    <th class="text-end">CA g√©n√©r√©</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let p of data.produits_plus_vendus">
                    <td>{{ p.nom }}</td>
                    <td class="text-end">{{ p.quantite_vendue }}</td>
                    <td class="text-end">{{ p.ca_genere | number:'1.0-0' }} Ar</td>
                  </tr>
                  <tr *ngIf="data.produits_plus_vendus.length === 0">
                    <td colspan="3" class="text-muted text-center">Aucune donn√©e</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header"><h5 class="mb-0">üìâ Produits moins performants</h5></div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Produit</th>
                    <th class="text-end">Qt√© vendue</th>
                    <th class="text-end">CA g√©n√©r√©</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let p of data.produits_moins_performants">
                    <td>{{ p.nom }}</td>
                    <td class="text-end">{{ p.quantite_vendue }}</td>
                    <td class="text-end">{{ p.ca_genere | number:'1.0-0' }} Ar</td>
                  </tr>
                  <tr *ngIf="data.produits_moins_performants.length === 0">
                    <td colspan="3" class="text-muted text-center">Aucune donn√©e</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Produits appr√©ci√©s + stock faible -->
      <div class="row g-3 w-100 mb-4">

        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header"><h5 class="mb-0">‚ù§Ô∏è Produits les plus appr√©ci√©s</h5></div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Produit</th>
                    <th class="text-end">Favoris</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let p of data.produits_plus_apprecies">
                    <td>{{ p.nom }}</td>
                    <td class="text-end">{{ p.nombre_favoris }}</td>
                  </tr>
                  <tr *ngIf="data.produits_plus_apprecies.length === 0">
                    <td colspan="2" class="text-muted text-center">Aucune donn√©e</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header"><h5 class="mb-0">‚ö†Ô∏è Produits en stock faible</h5></div>
            <div class="card-body p-0">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Produit</th>
                    <th class="text-end">Stock actuel</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let p of data.produits_stock_faible"
                      [class.table-danger]="p.qt_actuel === 0"
                      [class.table-warning]="p.qt_actuel > 0">
                    <td>{{ p.nom }}</td>
                    <td class="text-end fw-bold">{{ p.qt_actuel }}</td>
                  </tr>
                  <tr *ngIf="data.produits_stock_faible.length === 0">
                    <td colspan="2" class="text-muted text-center">Aucune donn√©e</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </ng-container>
  </main>
</div>